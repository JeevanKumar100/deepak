name: Launch EC2 Instance in Mumbai

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  launch-instance:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-south-1
      AMI_ID: ami-0f58b397bc5c1f2e8
      INSTANCE_TYPE: t2.micro
      KEY_NAME: new     # <-- Your key pair name (NO .pem)

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Launch EC2 Instance (Clean & Error-Free)
        shell: bash
        run: |
          set -e
          echo "Launching EC2 in $AWS_REGION..."

          # Auto-discover default VPC
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters Name=is-default,Values=true \
            --query "Vpcs[0].VpcId" --output text)

          echo "Default VPC: $VPC_ID"

          # Auto-discover subnet inside default VPC
          SUBNET_ID=$(aws ec2 describe-subnets \
            --filters Name=vpc-id,Values=$VPC_ID \
            --query "Subnets[0].SubnetId" --output text)

          echo "Using Subnet: $SUBNET_ID"

          # Auto-discover default security group
          SG_ID=$(aws ec2 describe-security-groups \
            --filters Name=vpc-id,Values=$VPC_ID Name=group-name,Values=default \
            --query "SecurityGroups[0].GroupId" --output text)

          echo "Using Security Group: $SG_ID"

          # Launch EC2 instance
          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id $AMI_ID \
            --instance-type $INSTANCE_TYPE \
            --key-name $KEY_NAME \
            --security-group-ids $SG_ID \
            --subnet-id $SUBNET_ID \
            --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=Github-EC2}]" \
            --query "Instances[0].InstanceId" \
            --output text)

          echo "Launched Instance ID: $INSTANCE_ID"

          # Optional: Fetch public IP
          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids $INSTANCE_ID \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)

          echo "Instance Public IP: $PUBLIC_IP"
